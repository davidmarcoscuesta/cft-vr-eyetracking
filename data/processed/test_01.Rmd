---
title: "Test_01"
author: "David Cuesta"
date: "2025-10-17"
output: html_document
---

```{r}
# =========================
# compare_interp.R
# =========================
library(tidyverse)

# ---- Carga los dos datasets ----
load("Interpdata_clean.Rdata")  # crea Interpdata
new <- Interpdata; rm(Interpdata)

load("Interpdata_old.Rdata") # crea Interpdata
old <- Interpdata; rm(Interpdata)

# ---- Alinea columnas comunes ----
common_cols <- intersect(names(old), names(new))
old <- old[, common_cols]
new <- new[, common_cols]

# ---- Verifica estructura ----
cat("üß± Dimensiones:\n")
print(rbind(old = dim(old), new = dim(new)))

cat("\nüìã Columnas en com√∫n:", length(common_cols), "\n\n")

# ---- Combina para comparaci√≥n ----
cmp <- inner_join(new %>% mutate(version = "new"),
                  old %>% mutate(version = "old"),
                  by = c("uniqueID", "t"),
                  suffix = c(".new", ".old"))

# ---- Calcular diferencias en variables clave ----
numeric_cols <- c("planeIntersect_x", "planeIntersect_y", "euc_vel", "ang_vel")
diff_summary <- map_dfr(numeric_cols, function(v){
  newv <- cmp[[paste0(v, ".new")]]
  oldv <- cmp[[paste0(v, ".old")]]
  tibble(
    variable = v,
    mean_abs_diff = mean(abs(newv - oldv), na.rm = TRUE),
    median_abs_diff = median(abs(newv - oldv), na.rm = TRUE),
    correlation = cor(newv, oldv, use = "pairwise.complete.obs")
  )
})

print(diff_summary)

# ---- Visual quick check ----
for (v in numeric_cols) {
  ggplot(cmp, aes(x = .data[[paste0(v, ".old")]], 
                  y = .data[[paste0(v, ".new")]])) +
    geom_point(alpha = 0.2, size = 0.6) +
    geom_abline(slope = 1, intercept = 0, color = "red") +
    labs(title = paste("Comparison:", v),
         x = "Old version", y = "New version") +
    theme_minimal() -> p
  print(p)
}

cat("\n‚úÖ Done. Correlations and scatterplots printed above.\n")

```

```{r}
table(is.na(new$planeIntersect_x))

```

```{r}
cmp_valid <- cmp %>% filter(is.finite(planeIntersect_x.new), is.finite(planeIntersect_x.old))
cor(cmp_valid$planeIntersect_x.new, cmp_valid$planeIntersect_x.old)
```

```{r}
bad_ids <- new %>%
  dplyr::group_by(uniqueID) %>%
  dplyr::summarise(
    min_x = suppressWarnings(min(planeIntersect_x, na.rm = TRUE)),
    min_y = suppressWarnings(min(planeIntersect_y, na.rm = TRUE))
  ) %>%
  dplyr::arrange(min_x) %>%
  dplyr::slice(1:5) %>%
  dplyr::pull(uniqueID)

bad_ids

```


```{r}
id <- bad_ids[1]
ggplot(new %>% dplyr::filter(uniqueID == id),
       aes(x = t)) +
  geom_line(aes(y = planeIntersect_x), color = "black", na.rm = TRUE) +
  geom_line(aes(y = planeIntersect_y), color = "red",   na.rm = TRUE) +
  labs(title = paste("Trial", id), y = "planeIntersect (m)", x = "t (ms)") +
  theme_minimal()

```


```{r}
# ¬øExiste ese trial en "new"?
"8_7" %in% unique(new$uniqueID)

# Si existe, dibuja:
ggplot(new %>% dplyr::filter(uniqueID == "8_2"),
       aes(x = t)) +
  geom_line(aes(y = planeIntersect_x), color = "black", na.rm = TRUE) +
  geom_line(aes(y = planeIntersect_y), color = "red",   na.rm = TRUE) +
  labs(title = "Trial 8_7", y = "planeIntersect (m)", x = "t (ms)") +
  theme_minimal()

```
```{r}
library(dplyr)
library(ggplot2)
library(DFA)

# --- Helper: calcula alpha DFA sobre una serie (regresi√≥n log-log) ---
dfa_alpha <- function(x) {
  x <- as.numeric(x)
  x <- x[is.finite(x)]
  if (length(x) < 200) return(NA_real_)  # m√≠nima longitud sensata
  # Serie integrada (detrending interno lo hace DFA::DFA con m=1)
  res <- try(DFA(x, scale = 2^(1/8), box_size = 4, m = 1), silent = TRUE)
  if (inherits(res, "try-error")) return(NA_real_)
  df <- as.data.frame(res)
  fit <- lm(log(DFA) ~ log(box), data = df)
  as.numeric(coef(fit)[2])
}

# --- Emparejar trials presentes en ambas versiones ---
ids <- intersect(unique(old$uniqueID), unique(new$uniqueID))

# Ventana: ¬±5 s alrededor de la transici√≥n entre objetos (t_targ1StartTime==0)
# Ajusta si quieres otra ventana.
WIN_MS <- 5000

rows <- lapply(ids, function(id) {
  o <- old %>% filter(uniqueID == id,
                      between(t_targ1StartTime, -WIN_MS, WIN_MS))
  n <- new %>% filter(uniqueID == id,
                      between(t_targ1StartTime, -WIN_MS, WIN_MS))

  # Aseguramos longitud m√≠nima
  if (nrow(o) < 200 || nrow(n) < 200) return(NULL)

  # Elige la se√±al: euc_vel o ang_vel
  alpha_old <- dfa_alpha(o$euc_vel)
  alpha_new <- dfa_alpha(n$euc_vel)

  data.frame(uniqueID = id, alpha_old = alpha_old, alpha_new = alpha_new)
})

cmp <- bind_rows(rows) %>% filter(is.finite(alpha_old), is.finite(alpha_new))

# --- Resumen y test pareado ---
summary(cmp)
mean_diff <- mean(cmp$alpha_new - cmp$alpha_old, na.rm = TRUE)
cat(sprintf("ŒîŒ± (new - old): %.3f\n", mean_diff))
print(t.test(cmp$alpha_new, cmp$alpha_old, paired = TRUE))

# --- Gr√°fico de dispersi√≥n (l√≠nea identidad) ---
ggplot(cmp, aes(x = alpha_old, y = alpha_new)) +
  geom_abline(slope = 1, intercept = 0, color = "red", linewidth = 0.7) +
  geom_point(alpha = 0.6) +
  coord_equal() +
  labs(title = "DFA Œ±: new vs old (¬±5 s alrededor de la transici√≥n)",
       x = "Œ± (old)", y = "Œ± (new)") +
  theme_minimal()


```

